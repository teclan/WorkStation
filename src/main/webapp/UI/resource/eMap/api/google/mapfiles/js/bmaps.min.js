function initialize(){var g=new BMap.TileLayer({isTransparentPng:true});g.getTilesUrl=function(j,k){var e=j.x,m=j.y,l=(e+m)%4+1;return"http://online"+l+".map.bdimg.com/tile/?qt=tile&x="+e+"&y="+m+"&z="+k+"&styles=pl&udt="+mtd.normalUDT;
};BMAP_NORMAL_MAP=new BMap.MapType("BMAP_NORMAL_MAP",g,{minZoom:3,maxZoom:19});var b=new BMap.TileLayer({isTransparentPng:true});b.getTilesUrl=function(j,k){var e=j.x,m=j.y,l=(e+m)%4+1;
return"http://or"+l+".map.baidu.com/it/u=x="+e+";y="+m+";z="+k+";v="+mtd.normalVer+";type=web&fm=41&udt="+mtd.normalUDT;};BMAP_NORMAL_MAP_HD=new BMap.MapType("BMAP_NORMAL_MAP_HD",b,{minZoom:3,maxZoom:18});
var d=new BMap.TileLayer({isTransparentPng:true});d.getTilesUrl=function(j,k){var e=j.x,m=j.y,l=(e+m)%4+1;return"http://or"+l+".map.baidu.com/it/u=x="+e+";y="+m+";z="+k+";v="+mtd.normalVer+";type=web&fm=43&udt="+mtd.normalUDT;
};var c=new BMap.TileLayer({isTransparentPng:true});c.getTilesUrl=function(j,k){var e=j.x,m=j.y,l=(e+m)%4+1;return"http://shangetu"+l+".map.bdimg.com/it/u=x="+e+";y="+m+";z="+k+";v="+mtd.satelliteVer+";type=sate&fm=46&udt="+mtd.satelliteUDT;
};BMAP_HYBRID_MAP_HD=new BMap.MapType("BMAP_HYBRID_MAP_HD",[c,d],{minZoom:3,maxZoom:18});var f=new BMap.TileLayer({isTransparentPng:true});f.getTilesUrl=function(j,k){var e=j.x,m=j.y,l=(e+m)%4+1;
return"http://online"+l+".map.bdimg.com/tile/?qt=tile&x="+e+"&y="+m+"&z="+k+"&v="+mtd.satelliteStreetVer+"&styles=sl&udt="+mtd.satelliteStreetUDT;};BMAP_HYBRID_MAP=new BMap.MapType("BMAP_HYBRID_MAP",[c,f],{minZoom:3,maxZoom:19});
BMAP_SATELLITE_MAP=new BMap.MapType("BMAP_SATELLITE_MAP",[c],{minZoom:3,maxZoom:19});mtd.map=new BMap.Map("map_canvas",{mapType:BMAP_NORMAL_MAP});mtd.map.addControl(new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_RIGHT}));
mtd.projection=mtd.map.getMapType().getProjection();mtd.boundary=new BMap.Boundary();mtd.map.enableScrollWheelZoom();mtd.map.enableContinuousZoom();mtd.map.enableInertialDragging();
mtd.map.enableKeyboard();mtd.map.centerAndZoom(new BMap.Point(mtd.DEFAULT_LONGITUDE,mtd.DEFAULT_LATITUDE),mtd.DEFAULT_ZOOM);switch(mtd.DEFAULT_MAPTYPE_INDEX){case 0:mtd.DEFAULT_MAPTYPE=BMAP_NORMAL_MAP;
break;case 1:mtd.DEFAULT_MAPTYPE=BMAP_NORMAL_MAP_HD;break;case 2:mtd.DEFAULT_MAPTYPE=BMAP_SATELLITE_MAP;break;case 3:mtd.DEFAULT_MAPTYPE=BMAP_HYBRID_MAP;
break;case 4:mtd.DEFAULT_MAPTYPE=BMAP_HYBRID_MAP_HD;break;default:mtd.DEFAULT_MAPTYPE=BMAP_PERSPECTIVE_MAP;}mtd.map.setMapType(mtd.DEFAULT_MAPTYPE);if(mtd.DEFAULT_MAPTYPE==BMAP_PERSPECTIVE_MAP){var a=new BMap.Point(116.4035,39.915);
mtd.map.setCurrentCity("北京");mtd.map.centerAndZoom(a,16);}mtd.map.addControl(new BMap.ScaleControl({offset:new BMap.Size(20,2),anchor:BMAP_ANCHOR_BOTTOM_RIGHT}));
mtd.map.addControl(new BMap.OverviewMapControl({isOpen:false}));try{delphiMapZoomChangedEvent(mtd.DEFAULT_ZOOM);}catch(h){}initDrawingManager();mtd.trafficControl=new BMapLib.TrafficControl({showPanel:false,anchor:BMAP_ANCHOR_TOP_LEFT,offset:new BMap.Size(10,15)});
mtd.map.addControl(mtd.trafficControl);var i={gridSize:60,maxZoom:12};mtd.markerClusterer=new BMapLib.MarkerClusterer(mtd.map,i);}function addTrafficTileLayer(){mtd.trafficControl.showTraffic();
mtd.hasTrafficTileLayer=true;}function removeTrafficTileLayer(){if(mtd.trafficControl){mtd.trafficControl.hideTraffic();}mtd.hasTrafficTileLayer=false;
}function initDrawingManager(){var a=function(f){if(f.drawingMode!=BMAP_DRAWING_MARKER){clearOverlay();}var b="";if(f.drawingMode==BMAP_DRAWING_MARKER){var c=f.overlay,k=c.getPosition();
mtd.map.removeOverlay(c);mtd.tempMarkerCount=mtd.tempMarkerCount+1;var j=getUniqueId(),h="我的标记 "+(getPOICount()+1).toString();addPOI(j,h,k.lat,k.lng,"",true,false);
delphiMarkerCompletedEvent(j.toString(),k.lat,k.lng,h,"",true);}else{if(f.drawingMode==BMAP_DRAWING_CIRCLE){b=f.overlay.getCenter().lng+","+f.overlay.getCenter().lat+","+f.overlay.getRadius();
}else{if(f.drawingMode==BMAP_DRAWING_POLYLINE||f.drawingMode==BMAP_DRAWING_POLYGON||f.drawingMode==BMAP_DRAWING_RECTANGLE){var g=f.overlay.getPath();if(f.drawingMode==BMAP_DRAWING_RECTANGLE){b=g[0].lng.toFixed(5)+","+g[0].lat.toFixed(5)+","+g[2].lng.toFixed(5)+","+g[2].lat.toFixed(5);
}else{for(var d=g.length-1;d>=0;d--){if(b){b=b+","+g[d].lng.toFixed(5)+","+g[d].lat.toFixed(5);}else{b=g[d].lng.toFixed(5)+","+g[d].lat.toFixed(5);}}}mtd.customPolygon=f.overlay;
}}}delphiPlotLatlngsEvent(b);if(mtd.label){mtd.map.removeOverlay(mtd.label);}mtd.label=f.label;if(f.drawingMode!=BMAP_DRAWING_MARKER){f.overlay.enableEditing();
f.overlay.addEventListener("lineupdate",function(){delphiPlotLatlngsEvent(getOverlayLatlngs(f.overlay));});}mtd.drawingManager.close();};mtd.scaledDrawingBar=true;
mtd.offsetX=mtd.scaledDrawingBar?mtd.offsetX:5;mtd.offsetY=mtd.scaledDrawingBar?mtd.offsetY:5;mtd.drawingManager=new BMapLib.DrawingManager(mtd.map,{isOpen:false,enableCalculate:true,drawingToolOptions:{anchor:BMAP_ANCHOR_TOP_LEFT,offset:new BMap.Size(20,5),scale:0.5,drawingModes:[BMAP_DRAWING_MARKER,BMAP_DRAWING_POLYLINE,BMAP_DRAWING_POLYGON,BMAP_DRAWING_RECTANGLE]},enableDrawingTool:true,circleOptions:mtd.styleOptions,polylineOptions:mtd.styleOptions,polygonOptions:mtd.styleOptions,rectangleOptions:mtd.styleOptions});
mtd.drawingManager.addEventListener("overlaycomplete",a);mtd.map.addEventListener("moveend",function(){var b=mtd.map.getCenter();delphiMapCenterChangedEvent(b.lat,b.lng);
});mtd.map.addEventListener("rightclick",clearAllOverlays);mtd.map.addEventListener("mousemove",function(d){var c=d.point.lat,b=d.point.lng;delphiMapMousemoveEvent(c,b);
});mtd.map.addEventListener("zoomend",function(){var b=this.getZoom();delphiMapZoomChangedEvent(b);});}function addNewMarker(d,j,k,a,c,l,e,n,b){var i=new BMap.Point(k,j);
var h=mtd.markers[d];if(h){h.setPosition(i);}else{h=new BMap.Marker(i,{icon:new BMap.Icon("mapfiles/markers2/marker-icon.png",new BMap.Size(15,41)),offset:new BMap.Size(0,-10),title:c});
mtd.markers[d]=h;mtd.markerClusterer.addMarker(h);}var g="<b>"+c+"</b><br>地址："+l;if(e){g+="<br>电话："+e;}if(n){g+="<br>标签："+n;}var f=new BMap.InfoWindow(g,{offset:new BMap.Size(0,-20),enableMessage:false,enableAutoPan:false});
h.addEventListener("click",function(){this.openInfoWindow(f);});if(a){var m=mtd.map.getZoom();setCenterAndZoom(j,k,m<13?13:m);h.openInfoWindow(f);}}function addMarker(e,c,d){clearAllOverlays();
setCenterAndZoom(e,c,d);var a=new BMap.Point(c,e);var b=new BMap.Marker(a,{icon:new BMap.Icon("mapfiles/markers2/red-dot.png",new BMap.Size(32,32)),title:e.toFixed(8)+","+c.toFixed(8)});
mtd.map.addOverlay(b);}function addLabel(a,c){var b=new BMap.Label(c,{position:a,offset:new BMap.Size(-45,-25)});b.setStyle({borderColor:"#808080",color:"#333",backgroundColor:"#F4F4F4"});
mtd.map.addOverlay(b);mtd.label=b;}function calculateAera(e,d){var c=0;if(BMapLib.GeoUtils){var b=d;var g=false;var f=e.toString();switch(f){case"[object Polyline]":c=BMapLib.GeoUtils.getPolylineDistance(e);
break;case"[object Polygon]":c=BMapLib.GeoUtils.getPolygonArea(e);b=e.getBounds().getCenter();g=true;break;case"[object Circle]":var a=e.getRadius();c=Math.PI*a*a;
b=e.getCenter();g=true;break;}if(!c||c<0){c=0;}else{c=c.toFixed(3);}addLabel(b,formatCalculateResult(c,g));}}function getOverlayLatlngs(c){var j=0,a="",f=true,b=null,h=null,g=c.toString();
switch(g){case"[object Polyline]":f=false;h=c.getPath();b=h[h.length-1];j=BMapLib.GeoUtils.getPolylineDistance(c);break;case"[object Polygon]":b=c.getBounds().getCenter();
j=BMapLib.GeoUtils.getPolygonArea(c);h=c.getPath();if(h.length<0){a=h[0].lng.toFixed(5)+","+h[0].lat.toFixed(5)+","+h[2].lng.toFixed(5)+","+h[2].lat.toFixed(5);
}else{for(var d=h.length-1;d>=0;d--){if(a){a=a+","+h[d].lng.toFixed(5)+","+h[d].lat.toFixed(5);}else{a=h[d].lng.toFixed(5)+","+h[d].lat.toFixed(5);}}}break;
case"[object Circle]":var e=c.getRadius();b=c.getCenter();j=Math.PI*e*e;a=c.getCenter().lng+","+c.getCenter().lat+","+c.getRadius();break;}if(mtd.label){mtd.label.setContent(formatCalculateResult(j,f));
mtd.label.setPosition(b);mtd.label.setOffset(new BMap.Size(-45,-25));}return a;}function clearOverlay(){var b=mtd.map.getOverlays();for(var a=0;a<b.length-3;
a++){if(b[a].toString()!="[object Marker]"){mtd.map.removeOverlay(b[a]);}}b.length=0;}function clearAllOverlays(){mtd.map.clearOverlays();mtd.markers=[];
mtd.markerClusterer.clearMarkers();}function getBoundary(a){mtd.map.clearOverlays();mtd.boundary.get(a,function(d){delphiPlotLatlngsEvent(d.boundaries[0]);
var g=d.boundaries.length;for(var f=0;f<g;f++){var k=new BMap.Polygon(d.boundaries[f],mtd.styleOptions);mtd.map.addOverlay(k);if(f===0){var l=k.getPath();
mtd.map.setViewport(l);var c=[];var b=0;for(var e=l.length-1;e>=0;e--){c[b++]=l[e--];}var h=new BMap.Polygon(c,mtd.styleOptions);calculateAera(h,c[0]);
}}});}function fullView(){setCenterAndZoom(32.694866,105.996094,4);}function showCurrentView(){clearAllOverlays();var c=mtd.map.getBounds().getNorthEast(),b=mtd.map.getBounds().getSouthWest();
var a=c.lng.toFixed(5)+","+c.lat.toFixed(5)+","+b.lng.toFixed(5)+","+b.lat.toFixed(5);delphiPlotLatlngsEvent(a);var d=[];d.push([d.push(new BMap.Point(c.lng,c.lat)),d.push(new BMap.Point(c.lng,b.lat)),d.push(new BMap.Point(b.lng,b.lat)),d.push(new BMap.Point(b.lng,c.lat))]);
mtd.customPolygon=new BMap.Polygon(d,mtd.styleOptions);mtd.map.addOverlay(mtd.customPolygon);}function setCenterAndZoom(c,a,b){mtd.map.centerAndZoom(new BMap.Point(a,c),b);
}function tileToLatlng(d,c){var e=Math.pow(2,c-18);var b=new BMap.Pixel(d.x*256,(d.y+1)*256);var a=new BMap.Pixel(b.x/e,b.y/e);return mtd.projection.pointToLngLat(a);
}function latlngToTile(d,f,g){var c=new BMap.Point(f,d);var b=Math.pow(2,g-18);var a=mtd.projection.lngLatToPoint(c);var e=new BMap.Pixel(Math.floor(a.x*b),Math.floor(a.y*b));
var i=new BMap.Pixel(Math.floor(e.x/256),Math.floor(e.y/256));c=tileToLatlng(i,g);var h=(i.x+","+i.y+","+c.lng+","+c.lat);return h;}function showBoundary(c){clearAllOverlays();
var e=c.length,d=0,m=[],k=[],h=0,i=0;while(d<e){var j,a=0,l=0;do{j=c.charCodeAt(d++)-63;l|=(j&31)<<a;a+=5;}while(j>=32);var f=((l&1)?~(l>>1):(l>>1));h+=f;
a=0;l=0;do{j=c.charCodeAt(d++)-63;l|=(j&31)<<a;a+=5;}while(j>=32);var g=((l&1)?~(l>>1):(l>>1));i+=g;m.push(new BMap.Point(i*0.00001,h*0.00001));k.push(i*0.00001,h*0.00001);
}if(m.length===2){m.splice(1,0,new BMap.Point(m[1].lng,m[0].lat));m.push(new BMap.Point(m[0].lng,m[2].lat));}if(m.length<=3){return false;}mtd.customPolygon=new BMap.Polygon(m,mtd.styleOptions);
calculateAera(mtd.customPolygon,m[0]);mtd.map.addOverlay(mtd.customPolygon);mtd.map.setViewport(mtd.customPolygon.getPath());delphiPlotLatlngsEvent(k.toString());
return true;}function decodePath(c){var e=c.length,d=0,g=[],i=0,j=0;while(d<e){var k,a=0,m=0;do{k=c.charCodeAt(d++)-63;m|=(k&31)<<a;a+=5;}while(k>=32);
var f=((m&1)?~(m>>1):(m>>1));i+=f;a=0;m=0;do{k=c.charCodeAt(d++)-63;m|=(k&31)<<a;a+=5;}while(k>=32);var h=((m&1)?~(m>>1):(m>>1));j+=h;g.push([i*0.00001,j*0.00001]);
}var l=g.toString();return l;}function getPOIMarker(c){var b=0,a=null;for(b=0;b<mtd.pois.length;b++){a=mtd.pois[b];if(a.id===c){return a;}}return null;
}function deletePOIMarker(c){var b=0,a=null;for(b=mtd.pois.length-1;b>=0;b--){a=mtd.pois[b];if((a)&&(a.id===c)){mtd.map.removeOverlay(a.label);mtd.map.removeOverlay(a);
mtd.pois.splice(b,1);}}}function deleteTempPOIMarkers(){if(mtd.tempMarkerCount===0){return;}var b=0,a=null;for(b=mtd.pois.length-1;b>=0;b--){a=mtd.pois[b];
if((a)&&(a.isTemp)){mtd.map.removeOverlay(a.label);mtd.map.removeOverlay(a);mtd.pois.splice(b,1);}}mtd.tempMarkerCount=0;}function getPOICount(){return mtd.pois.length;
}function addPOI(d,c,h,i,g,f,b){var j=new BMap.Point(i,h),e=getPOIMarker(d);if(e){if(e.isTemp){e.setIcon(new BMap.Icon("mapfiles/icons/marker-red.png",new BMap.Size(32,32)));
}e.setTitle(c);e.setPosition(j);e.isTemp=false;e.content=g;e.label.setContent(c);e.label.setPosition(j);}else{var a=(f)?"mapfiles/icons/marker-blue.png":"mapfiles/icons/marker-red.png";
e=new BMap.Marker(j,{enableMassClear:false,enableDragging:true,raiseOnDrag:false,icon:new BMap.Icon(a,new BMap.Size(32,32)),title:c});e.id=d;e.isTemp=f;
e.content=g;mtd.pois.push(e);mtd.map.addOverlay(e);e.label=new BMap.Label(c,{position:j,offset:new BMap.Size(-35,-35)});e.label.setStyle({borderColor:"#808080",color:"#333",padding:"1px 3px 1px 3px",borderRadius:"3px",backgroundColor:"#F4F4F4"});
mtd.map.addOverlay(e.label);}e.addEventListener("click",function(){var l=this.getPosition();delphiMarkerCompletedEvent(this.id.toString(),l.lat,l.lng,this.getTitle(),this.content,this.isTemp);
});e.addEventListener("dragend",function(){var l=this.getPosition();delphiMarkerCompletedEvent(this.id.toString(),l.lat,l.lng,this.getTitle(),this.content,this.isTemp);
});e.addEventListener("dragging",function(){this.label.setPosition(this.getPosition());});e.addEventListener("dragstart",function(){this.label.setPosition(this.getPosition());
});if(b){var k=mtd.map.getZoom();mtd.map.centerAndZoom(j,(k<14)?14:k);}}